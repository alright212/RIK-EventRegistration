@using System.Linq
@model EventRegistration.Application.EventDetailViewModel
@{
    ViewData["Title"] = "Osavõtjad";
}

<div class="px-4 py-3">
    <div class="flex mb-4 h-16">
        <div class="flex w-full">
            <div class="w-1/3 main-blue-bg text-white flex items-center p-3 sm:p-4">
                <h1 class="text-xl sm:text-2xl font-bold m-0">Osavõtjad</h1>
            </div>
            <div class="w-2/3">
                <img src="~/images/osalejad.png" alt="Osavõtjate päis" class="w-full h-full object-cover" onerror="this.onerror=null;this.src='https://placehold.co/600x300/a0aec0/ffffff?text=Image';" />
            </div>
        </div>
    </div>

    <div class="bg-white p-4 sm:p-6">
        <div class="mb-4">
            <h2 class="text-lg font-bold">@Model.Event.Name</h2>
            <div class="text-sm text-gray-600">
                <p><strong>Toimumisaeg:</strong> @Model.Event.EventTime.ToString("dd.MM.yyyy")</p>
                <p><strong>Koht:</strong> @Model.Event.Location</p>
            </div>
        </div>

        <h3 class="font-bold text-md mb-2">Osavõtjad:</h3>
        
        @if (Model.Participants != null && Model.Participants.Any())
        {
            <div class="space-y-2">
                @foreach (var (participant, index) in Model.Participants.Select((p, i) => (p, i + 1)))
                {
                    <div class="grid grid-cols-12 gap-x-4 items-center border-b py-2">
                        <div class="col-span-1 text-right">@index.</div>
                        <div class="col-span-5 font-semibold">
                            @participant.FullName
                        </div>
                        <div class="col-span-3 text-gray-500">
                            @if (participant.ParticipantType == "Individual")
                            {
                                @participant.PersonalIdCode
                            }
                            else
                            {
                                @participant.RegistryCode
                            }
                        </div>
                        <div class="col-span-3 flex justify-end space-x-2">
                            <a asp-controller="Participants" asp-action="Details" asp-route-eventId="@Model.Event.Id" asp-route-participantId="@participant.ParticipantId" class="text-blue-600 hover:underline text-sm">VAATA</a>
                            <form asp-controller="Participants" asp-action="Delete" asp-route-eventId="@Model.Event.Id" asp-route-participantId="@participant.ParticipantId" method="post" onsubmit="return confirm('Kas olete kindel, et soovite selle osavõtja kustutada?');" style="display: inline;">
                                @Html.AntiForgeryToken()
                                <button type="submit" class="text-red-600 hover:underline text-sm">KUSTUTA</button>
                            </form>
                        </div>
                    </div>
                }
            </div>
        }
        else
        {
            <p class="text-center text-gray-500 py-4">Osavõtjaid ei ole veel lisatud.</p>
        }

        <hr class="my-6"/>

        <div>
            <h3 class="text-lg font-bold mb-4">Osavõtjate lisamine</h3>
            
            <!-- Add Participant Form -->
            <form asp-controller="Participants" asp-action="Add" method="post" class="bg-gray-50 p-6 rounded-lg">
                @Html.AntiForgeryToken()
                <input type="hidden" name="EventId" value="@ViewBag.EventId" />
                
                <!-- Display validation errors from TempData -->
                @if (TempData["ValidationErrors"] != null)
                {
                    <div class="text-red-600 mb-4">
                        <ul>
                            @{
                                var validationErrors = TempData["ValidationErrors"] as Dictionary<string, string[]>;
                                foreach (var error in validationErrors ?? new Dictionary<string, string[]>())
                                {
                                    foreach (var message in error.Value)
                                    {
                                        <li>@message</li>
                                    }
                                }
                            }
                        </ul>
                    </div>
                }
                
                <!-- Participant Type Selection -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-3">Osavõtja tüüp:</label>
                    <div class="flex space-x-4">
                        <label class="inline-flex items-center">
                            <input type="radio" name="ParticipantType" value="Individual" class="form-radio text-blue-600" 
                                   @(TempData["ParticipantType"]?.ToString() != "Company" ? "checked" : "") />
                            <span class="ml-2">Eraisik</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="ParticipantType" value="Company" class="form-radio text-blue-600" 
                                   @(TempData["ParticipantType"]?.ToString() == "Company" ? "checked" : "") />
                            <span class="ml-2">Ettevõte</span>
                        </label>
                    </div>
                </div>

                <!-- Individual Participant Fields -->
                <div id="individual-fields" class="participant-fields" style="@(TempData["ParticipantType"]?.ToString() == "Company" ? "display: none;" : "")">
                    <div class="grid md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Eesnimi:</label>
                            <input name="Individual.FirstName" value="@TempData["Individual.FirstName"]" class="block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Perekonnanimi:</label>
                            <input name="Individual.LastName" value="@TempData["Individual.LastName"]" class="block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" />
                        </div>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Isikukood:</label>
                        <input name="Individual.PersonalIdCode" value="@TempData["Individual.PersonalIdCode"]" class="block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="38512345678" />
                    </div>
                </div>

                <!-- Company Participant Fields -->
                <div id="company-fields" class="participant-fields" style="@(TempData["ParticipantType"]?.ToString() == "Company" ? "" : "display: none;")">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Juriidiline nimi:</label>
                        <input name="Company.LegalName" value="@TempData["Company.LegalName"]" class="block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" />
                    </div>
                    <div class="grid md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Registrikood:</label>
                            <input name="Company.RegistryCode" value="@TempData["Company.RegistryCode"]" class="block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="12345678" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Osavõtjate arv:</label>
                            <input name="Company.NumberOfParticipants" value="@TempData["Company.NumberOfParticipants"]" type="number" min="1" class="block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" />
                        </div>
                    </div>
                </div>

                <!-- Payment Method (Common for both) -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Makseviis:</label>
                    <select id="payment-method-individual" name="Individual.PaymentMethodId" class="block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" style="@(TempData["ParticipantType"]?.ToString() == "Company" ? "display: none;" : "")">
                        <option value="">Vali makseviis</option>
                        @foreach (var paymentMethod in ViewBag.PaymentMethods)
                        {
                            if (TempData["Individual.PaymentMethodId"]?.ToString() == paymentMethod.Value)
                            {
                                <option value="@paymentMethod.Value" selected="selected">@paymentMethod.Text</option>
                            }
                            else
                            {
                                <option value="@paymentMethod.Value">@paymentMethod.Text</option>
                            }
                        }
                    </select>
                    <select id="payment-method-company" name="Company.PaymentMethodId" class="block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" style="@(TempData["ParticipantType"]?.ToString() == "Company" ? "" : "display: none;")">
                        <option value="">Vali makseviis</option>
                        @foreach (var paymentMethod in ViewBag.PaymentMethods)
                        {
                            if (TempData["Company.PaymentMethodId"]?.ToString() == paymentMethod.Value)
                            {
                                <option value="@paymentMethod.Value" selected="selected">@paymentMethod.Text</option>
                            }
                            else
                            {
                                <option value="@paymentMethod.Value">@paymentMethod.Text</option>
                            }
                        }
                    </select>
                </div>

                <!-- Additional Info (Common for both) -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Lisainfo:</label>
                    <textarea id="additional-info-individual" name="Individual.AdditionalInfo" rows="3" class="block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Märkused või erinõuded..." style="@(TempData["ParticipantType"]?.ToString() == "Company" ? "display: none;" : "")">@TempData["Individual.AdditionalInfo"]</textarea>
                    <textarea id="additional-info-company" name="Company.AdditionalInfo" rows="3" class="block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Märkused või erinõuded..." style="@(TempData["ParticipantType"]?.ToString() == "Company" ? "" : "display: none;")">@TempData["Company.AdditionalInfo"]</textarea>
                </div>

                <!-- Submit Button -->
                <div class="flex justify-end">
                    <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        Lisa osavõtja
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const individualRadio = document.querySelector('input[value="Individual"]');
    const companyRadio = document.querySelector('input[value="Company"]');
    const individualFields = document.getElementById('individual-fields');
    const companyFields = document.getElementById('company-fields');
    const paymentMethodIndividual = document.getElementById('payment-method-individual');
    const paymentMethodCompany = document.getElementById('payment-method-company');
    const additionalInfoIndividual = document.getElementById('additional-info-individual');
    const additionalInfoCompany = document.getElementById('additional-info-company');

    function toggleFields() {
        if (individualRadio.checked) {
            individualFields.style.display = 'block';
            companyFields.style.display = 'none';
            paymentMethodIndividual.style.display = 'block';
            paymentMethodCompany.style.display = 'none';
            additionalInfoIndividual.style.display = 'block';
            additionalInfoCompany.style.display = 'none';
        } else {
            individualFields.style.display = 'none';
            companyFields.style.display = 'block';
            paymentMethodIndividual.style.display = 'none';
            paymentMethodCompany.style.display = 'block';
            additionalInfoIndividual.style.display = 'none';
            additionalInfoCompany.style.display = 'block';
        }
    }

    individualRadio.addEventListener('change', toggleFields);
    companyRadio.addEventListener('change', toggleFields);
    
    // Initial state - this will override server-side styling if JavaScript is enabled
    toggleFields();
});
</script>